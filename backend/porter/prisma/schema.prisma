// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

/// ========================================
/// Porter Request Database Schema
/// ========================================

model PorterRequest {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// Requester Information
  requesterDepartment Int? // เก็บ departmentSubSubId แทนชื่อหน่วยงาน
  requesterUserID     String @map("requester_user_id")
  requesterName       String
  requesterPhone      String @db.VarChar(20)

  /// Patient Information
  patientName     String
  patientHN       String @db.VarChar(50)
  patientCondition Json?

  /// Pickup Location
  pickupBuildingId         String
  pickupFloorDepartmentId  String
  pickupRoomBedName        String?

  /// Delivery Location
  deliveryBuildingId         String
  deliveryFloorDepartmentId  String
  deliveryRoomBedName        String?

  /// Transport Meta
  requestedDateTime DateTime
  urgencyLevel      String @db.VarChar(50)
  vehicleType       String @db.VarChar(50)
  hasVehicle        String @db.VarChar(50)
  returnTrip        String @db.VarChar(50)
  transportReason   String @db.VarChar(200)

  equipment Json
  equipmentOther String? @db.VarChar(200)

  specialNotes String? @db.Text

  status        String @default("WAITING") @db.VarChar(50)
  assignedToId  String?

  acceptedAt  DateTime?
  acceptedById String? @db.VarChar(200)
  completedAt DateTime?
  cancelledAt DateTime?
  cancelledReason String? @db.Text
  cancelledById String? @db.VarChar(200)

  pickupAt   DateTime?
  deliveryAt DateTime?
  returnAt   DateTime?

  @@index([status])
  @@index([urgencyLevel])
  @@index([requestedDateTime])
  @@index([createdAt])
  @@index([assignedToId])
}

/// ========================================
/// Location Settings Schema
/// ========================================
model Building {
  id        String   @id @default(cuid())
  name      String   @db.VarChar(200)
  floorCount Int?
  status    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  floors FloorDepartment[]
  floorPlans FloorPlan[]

  @@index([name])
  @@index([status])
  @@index([createdAt])
}

model FloorDepartment {
  id        String   @id @default(cuid())
  name      String   @db.VarChar(200)
  buildingId String
  floorNumber Int?
  status    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  departmentType Int?
  roomType Int?
  roomCount Int?
  bedCount  Int?

  building Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)

  @@index([buildingId])
  @@index([departmentType])
  @@index([status])
}

model FloorPlan {
  id        String   @id @default(cuid())
  buildingId String
  floorNumber Int
  imageData String @db.LongText // base64 string
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  building Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  stations BleStation[]

  @@index([buildingId, floorNumber])
  @@unique([buildingId, floorNumber])
}

model BleStation {
  id        String   @id @default(cuid())
  floorPlanId String
  name      String   @db.VarChar(200)
  macAddress String  @unique @db.VarChar(17) // MAC address format: XX:XX:XX:XX:XX:XX
  uuid      String?  @db.VarChar(36) // UUID format
  positionX Float
  positionY Float
  signalStrength Int? // dBm
  batteryLevel Int? // percentage (0-100)
  status    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  floorPlan FloorPlan @relation(fields: [floorPlanId], references: [id], onDelete: Cascade)

  @@index([floorPlanId])
}

/// ========================================
/// Employee Management Schema
/// ========================================
model PorterEmployee {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  citizenId  String @unique @db.VarChar(13)
  firstName  String @db.VarChar(100)
  lastName   String @db.VarChar(100)
  nickname   String? @db.VarChar(100) // ชื่อเล่น
  profileImage String? @db.LongText // รูปภาพโปรไฟล์ (base64 string) - ใช้ LONGTEXT สำหรับรองรับ base64 ที่ยาว

  employmentTypeId Int // ชี้ไปที่ hrd_person_type.HR_PERSON_TYPE_ID
  positionId       Int // ชี้ไปที่ hrd_position.HR_POSITION_ID

  userId String? @unique @map("user_id") // Map กับ user.id จาก user table

  status Boolean @default(true)

  // หมายเหตุ: ไม่สามารถสร้าง foreign key relation กับ hrd tables ได้เพราะอยู่ใน database อื่น
  // ต้องดึงข้อมูลจาก hrd tables แบบ manual ที่ service layer

  @@index([citizenId])
  @@index([status])
  @@index([employmentTypeId])
  @@index([positionId])
  @@index([userId])
}

/// ========================================
/// EMRC Ambulance Request Database Schema
/// ========================================

model AmbulanceRequest {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// Requester Information
  requesterDepartment Int? // เก็บ departmentSubSubId แทนชื่อหน่วยงาน
  requesterUserID     String @map("requester_user_id")
  requesterName       String
  requesterPhone      String @db.VarChar(20)

  /// Basic Information
  requestDate String @db.VarChar(10) // MM/DD/YYYY format
  requestTime String @db.VarChar(5) // HH:mm format
  bookingPurpose String @db.VarChar(50) // SEND_HOME, TRANSFER_WARD, SEND_EXAM, REFER_IN, REFER_OUT, CT, DIALYSIS, OTHER
  bookingPurposeOther String? @db.VarChar(200)

  /// Additional Details (for SEND_HOME)
  patientName String? @db.VarChar(200)
  patientBirthDate String? @db.VarChar(10) // dd/mm/yyyy format
  destinationAddress String? @db.Text
  patientRights String? @db.VarChar(100)
  patientHN String? @db.VarChar(50)
  patientCitizenId String? @db.VarChar(13)
  patientPhone String? @db.VarChar(20)
  requiredEquipment Json // Array of equipment: ROOM_AIR, IV, OXYGEN, HFNC, VENTILATOR, MONITOR, DEFIBRILLATOR
  infectionStatus String @db.VarChar(50) // DRUG_RESISTANT, TB, COVID_19, FLU_AB, RSV, NONE, OTHER
  infectionStatusOther String? @db.VarChar(200)
  departmentPhone String? @db.VarChar(20)
  requesterNameDetail String? @db.VarChar(200)
  conditionType String @db.VarChar(50) // ELDERLY, DISABLED
  acknowledged Boolean @default(false)

  /// Status Management
  status        String @default("WAITING") @db.VarChar(50)
  assignedToId  String?

  acceptedAt  DateTime?
  acceptedById String? @db.VarChar(200)
  completedAt DateTime?
  cancelledAt DateTime?
  cancelledReason String? @db.Text
  cancelledById String? @db.VarChar(200)

  pickupAt   DateTime?
  deliveryAt DateTime?
  returnAt   DateTime?

  @@index([status])
  @@index([bookingPurpose])
  @@index([requestDate])
  @@index([createdAt])
  @@index([assignedToId])
  @@index([requesterUserID])
}
