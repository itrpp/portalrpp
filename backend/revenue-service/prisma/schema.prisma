// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Model สำหรับเก็บข้อมูล Batch Upload
model UploadBatch {
  id              String   @id @default(cuid())
  batchId         String   @unique // Unique batch identifier
  batchName       String?  // ชื่อ batch (ถ้ามี)
  status          String   @default("created") // created, uploading, processing, completed, failed
  totalFiles      Int      @default(0) // จำนวนไฟล์ทั้งหมดใน batch
  uploadedFiles   Int      @default(0) // จำนวนไฟล์ที่อัปโหลดแล้ว
  processedFiles  Int      @default(0) // จำนวนไฟล์ที่ประมวลผลแล้ว
  totalRecords    Int      @default(0) // จำนวน records ทั้งหมด
  totalSize       Int      @default(0) // ขนาดไฟล์รวม (bytes)
  userId          String   // ID ของผู้ใช้
  userName        String   // ชื่อผู้ใช้
  ipAddress       String?  // IP address ของผู้ใช้
  uploadStartTime DateTime @default(now())
  uploadEndTime   DateTime? // เวลาที่อัปโหลดเสร็จ
  processingStartTime DateTime? // เวลาที่เริ่มประมวลผล
  processingEndTime DateTime? // เวลาที่ประมวลผลเสร็จ
  errorMessage    String?  // ข้อความ error (ถ้ามี)
  metadata        String?  // JSON string ของ metadata เพิ่มเติม
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  files File[]

  @@index([userId])
  @@index([status])
  @@index([batchId])
}

// Model สำหรับเก็บข้อมูลไฟล์ DBF
model File {
  id              String   @id @default(cuid())
  filename        String   // ชื่อไฟล์ที่บันทึกในระบบ
  originalName    String   // ชื่อไฟล์ต้นฉบับ
  size            Int      // ขนาดไฟล์ (bytes)
  status          String   @default("uploaded") // uploaded, processing, completed, error, validated
  fileType        String?  // ADP, OPD, CHT, CHA, INS, DRU
  schema          String?  // JSON string ของ schema
  userId          String   // ID ของผู้ใช้
  userName        String   // ชื่อผู้ใช้
  ipAddress       String?  // IP address ของผู้ใช้
  filePath        String?  // Path ของไฟล์ในระบบ
  uploadBatchId   String?  // ID ของ batch (ถ้าเป็นส่วนหนึ่งของ batch)
  uploadProgress  Int      @default(0) // ความคืบหน้าการอัปโหลด (0-100)
  validationStatus String? // validation status
  validationErrors String? // JSON string ของ validation errors
  recordCount     Int      @default(0) // จำนวน records ในไฟล์
  fieldCount      Int      @default(0) // จำนวน fields ในไฟล์
  checksum        String?  // MD5 checksum ของไฟล์
  uploadStartTime DateTime @default(now())
  uploadEndTime   DateTime? // เวลาที่อัปโหลดเสร็จ
  processingStartTime DateTime? // เวลาที่เริ่มประมวลผล
  processingEndTime DateTime? // เวลาที่ประมวลผลเสร็จ
  metadata        String?  // JSON string ของ metadata เพิ่มเติม
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  records Record[]
  schemas Schema[]
  processingLogs ProcessingLog[]
  exportLogs ExportLog[]
  validationLogs ValidationLog[]
  uploadBatch UploadBatch? @relation(fields: [uploadBatchId], references: [id])

  @@index([userId])
  @@index([fileType])
  @@index([status])
  @@index([uploadBatchId])
  @@index([uploadProgress])
}

// Model สำหรับเก็บข้อมูล Records จากไฟล์ DBF
model Record {
  id        String   @id @default(cuid())
  fileId    String   // ID ของไฟล์
  rowIndex  Int      // ลำดับของ record
  data      String   // JSON string ของข้อมูล record
  isValid   Boolean  @default(true) // สถานะการ validate
  validationErrors String? // JSON string ของ validation errors
  createdAt DateTime @default(now())

  // Relations
  file File @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([fileId])
  @@index([rowIndex])
  @@index([isValid])
}

// Model สำหรับเก็บข้อมูล Schema ของไฟล์ DBF
model Schema {
  id        String   @id @default(cuid())
  fileId    String   // ID ของไฟล์
  fieldName String   // ชื่อฟิลด์
  fieldType String   // ประเภทฟิลด์ (C, N, D, L, M)
  fieldLength Int    // ความยาวฟิลด์
  fieldDecimal Int   // จำนวนทศนิยม
  fieldOffset Int    // ตำแหน่งเริ่มต้นของฟิลด์
  isRequired Boolean @default(false) // ฟิลด์ที่จำเป็นหรือไม่
  validationRules String? // JSON string ของ validation rules
  createdAt DateTime @default(now())

  // Relations
  file File @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([fileId])
  @@index([fieldName])
  @@index([isRequired])
}

// Model สำหรับเก็บข้อมูลการประมวลผล
model ProcessingLog {
  id              String   @id @default(cuid())
  fileId          String   // ID ของไฟล์
  processType     String   // batch, individual, linked, validation
  processDetails  String?  // รายละเอียดการประมวลผล
  recordCount     Int      // จำนวน records ที่ประมวลผล
  processingTime  Int      // เวลาที่ใช้ในการประมวลผล (ms)
  status          String   @default("processing") // processing, completed, error, cancelled
  errorMessage    String?  // ข้อความ error (ถ้ามี)
  progress        Int      @default(0) // ความคืบหน้า (0-100)
  metadata        String?  // JSON string ของ metadata เพิ่มเติม
  userId          String   // ID ของผู้ใช้
  userName        String   // ชื่อผู้ใช้
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  file File @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([fileId])
  @@index([status])
  @@index([userId])
  @@index([processType])
}

// Model สำหรับเก็บข้อมูลการ Export
model ExportLog {
  id            String   @id @default(cuid())
  fileId        String   // ID ของไฟล์
  exportType    String   // DBF, CSV, JSON, Excel
  exportFormat  String?  // รูปแบบการ export
  recordCount   Int      // จำนวน records ที่ export
  fileSize      Int      // ขนาดไฟล์ที่ export (bytes)
  downloadPath  String?  // Path ของไฟล์ที่ export
  exportOptions String?  // JSON string ของ export options
  status        String   @default("processing") // processing, completed, error
  errorMessage  String?  // ข้อความ error (ถ้ามี)
  userId        String   // ID ของผู้ใช้
  userName      String   // ชื่อผู้ใช้
  createdAt     DateTime @default(now())
  completedAt   DateTime? // เวลาที่ export เสร็จ

  // Relations
  file File @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([fileId])
  @@index([exportType])
  @@index([userId])
  @@index([status])
}

// Model สำหรับเก็บข้อมูลการ Validate
model ValidationLog {
  id              String   @id @default(cuid())
  fileId          String   // ID ของไฟล์
  validationType  String   // schema, data, business_rules
  validationRules String?  // JSON string ของ validation rules
  totalRecords    Int      // จำนวน records ทั้งหมด
  validRecords    Int      // จำนวน records ที่ผ่าน validation
  invalidRecords  Int      // จำนวน records ที่ไม่ผ่าน validation
  validationErrors String? // JSON string ของ validation errors
  validationTime  Int      // เวลาที่ใช้ในการ validate (ms)
  status          String   @default("processing") // processing, completed, error
  userId          String   // ID ของผู้ใช้
  userName        String   // ชื่อผู้ใช้
  createdAt       DateTime @default(now())

  // Relations
  file File @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([fileId])
  @@index([validationType])
  @@index([status])
  @@index([userId])
}

// Model สำหรับเก็บข้อมูล User Activity
model UserActivity {
  id          String   @id @default(cuid())
  userId      String   // ID ของผู้ใช้
  userName    String   // ชื่อผู้ใช้
  activityType String  // upload, process, export, validate, login, logout
  activityDetails String? // รายละเอียดกิจกรรม
  ipAddress   String?  // IP address ของผู้ใช้
  userAgent   String?  // User agent
  metadata    String?  // JSON string ของ metadata เพิ่มเติม
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([activityType])
  @@index([createdAt])
} 